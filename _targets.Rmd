---
title: "Target Markdown"
output: html_document
---

# Set up targets environment

Here we run necessary code for `targets` setup.

```{r setup, include = FALSE}
here::set_here()
knitr::opts_chunk$set(collapse = TRUE, comment = "#>")

# load libraries for targets notebook
library(targets)
library(dplyr, quietly = TRUE)

# clean knitting history
tar_unscript()
```

# Dependencies

Here, we load packages and custom functions required in the pipeline.

```{r, engine="targets", example-globals, tar_globals = TRUE}
options(tidyverse.quiet = TRUE)

# load libraries for make
tar_option_set(packages = c("dplyr",
                            "tidyr",
                            "purrr",
                            "readr",
                            "quanteda",
                            "igraph",
                            "DiagrammeR",
                            "tibble",
                            "stringr",
                            "topicmodels",
                            "ggplot2",
                            "scales",
                            "ldatuning",
                            "quanteda",
                            "data.table",
                            "tidytext",
                            "tm",
                            "RSQLite",
                            "DBI",
                            "MatchIt"
                            ))

# read custom functions
lapply(list.files(here::here("R"), full.names = TRUE), source)
```

# Data import

```{r, engine="targets", data_import}
list(
    
     tar_target(ids_path, here::here("data", "raw", "supervisors.csv"), format = "file"),
     tar_target(ids, read.csv2(ids_path)),
     tar_target(gender_path, here::here("data", "raw", "names4api_tagged.tsv"), format = "file"),
     tar_target(gender, read.delim(gender_path)),
     # tar_target(gender, read.delim(here::here("data", "raw", "names4api_tagged.tsv")),
     #          format = "qs"),
      tar_target(db_path,
           here::here("data", "raw", "czech_sci_db.sqlite")),
      tar_target(ids_complete, create_ids_complete(ids, db_path)),
    tar_target(ids_complete_vector,
               make_ids_complete_vector(ids_complete))
   
    
    
    
    # tar_target(all_pubs,
    #        get_all_pubs(db_path, ids_complete), 
    #           format = "qs"),
    # tar_target(one_author,
    #        read_one_author(db_path, ids_complete_vector, ids_complete), 
    #           format = "qs")
    # 
)
```

# Matching and data preparation 

```{r, engine="targets", matching_preparation}
list(
    
      tar_target(matching, match(db_path, ids, gender)),
      tar_target(sup_path, here::here("data", "raw", "supervisors_control_final.csv"), format = "file"),
      tar_target(sup_control, read.csv2(sup_path)),
              
     # tar_target(sup_control, read.csv2(here::here("data", "raw", "supervisors_control.csv")),
     #          format = "qs"),
      tar_target(final_data, refine_data(matching, db_path, ids, sup_control)),
               
     #at this point, I will need to manually search for the supervisors of the control group researchers and upload their vedidks into new ids file
     tar_target(ids_full_vector,
               make_ids_full_vector(matching)),
    #  tar_target(all_pubs,
    #        get_all_pubs(db_path, matching, ids_complete), 
    #           format = "qs"),
    tar_target(all_authors,
           read_all_authors(db_path, ids_complete_vector, ids_complete, final_data, ids_full_vector))
    
)
```

# Topic model

```{r, engine="targets", topic_model}
list(
    
   # tar_target(topic_model_input,
   #            make_topic_model_input(all_pubs)) #,
   #                            
   #  # tar_target(topic_number,
   #  #           find_topic_number(topic_model_input),
   #  #             format = "qs") #, 
   #  # tar_target(topic_model,
   #  #            make_topic_model(topic_model_input),
   #  #             format = "qs")

    
)
```

# Coauthorship network

```{r, engine="targets", network}

list(

    # tar_target(edgelist,
    #            make_edgelist(one_author),
    #             format = "qs", pattern = map(one_author), iteration = "list"),
    # tar_target(graph, igraph::graph_from_data_frame(edgelist, directed = FALSE), pattern = map(edgelist), iteration = "list")
    tar_target(coauthorship,
               make_network(all_authors)),

     tar_target(coauthorship_graph,
               make_graph(coauthorship))

)

```

# Researcher independence indicator (RII) part 1 - eigenvector centrality

```{r, engine="targets", RII1}

list(
    
    # tar_target(eigen_centr,
    #            calc_eigen_centr(graph, ids_complete, one_author, db_path),
    #            format = "qs", pattern = map(graph, one_author), iteration = "list")
    # 
     tar_target(eigen_centrality,
               comp_eigen_centr(coauthorship_graph))
    
)

```

# Researcher independence indicator (RII) part 2 - clustering coefficient

```{r, engine="targets", RII2}

list(
    
    #  tar_target(clustering,
    #             calc_clustering(graph, ids_complete, one_author, db_path),
    #            format = "qs", pattern = map(graph, one_author), iteration = "list") 
    # #            
    # # 
    
    tar_target(cluster,
                comp_clustering(eigen_centrality))
    
    
)

```

# Researcher independence indicator (RII) part 3 - independent publications

```{r, engine="targets", RII3}

list(
    
     # tar_target(ind_pubs,
     #            calc_ind_pubs(one_author, ids_complete, db_path), 
     #            format = "qs", pattern = map(one_author),                  iteration = "list")
     # 
     tar_target(independent_pubs,
                comp_ind_pubs(cluster))
)

```

# Researcher independence indicator (RII) part 4 - independent topics

```{r, engine="targets", RII4}

list(
    
     # tar_target(ind_topics,
     #            calc_ind_topics(topic_model = NULL, one_author, ids_complete, db_path), 
     #            format = "qs", pattern = map(one_author), iteration = "list")
     # 
    tar_target(independent_topics,
                comp_ind_topics(independent_pubs))
)

```

# Researcher independence indicator (RII) part 4 - independent topics: alternative way via cosine similarity

```{r, engine="targets", RII4_2}

list(
    
    # tar_target(ind_topics_cs,
    #            calc_cos_sim(topic_model, two_authors), 
    #            format = "qs")
    # 
)

```

# Final indicator

```{r, engine="targets", final}

list(
    
    # tar_target(final_data,
    #            calc_final_data(eigen_centr, clustering, ind_topics, ind_pubs, matching),
    #            format = "qs") #,
    #  # tar_target(testing,
    #  #           just_test(db_path),
    #  #           format = "qs")
    
    tar_target(full_indicator,
               calc_full_indicator(independent_topics))

)


```
# Article

```{targets article}
list(
    # tarchetypes::tar_render(article, here::here("Rmd", "article.Rmd"))
)


```

etc... rinse and repeat

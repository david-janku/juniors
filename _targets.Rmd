---
title: "Target Markdown"
output: html_document
---

# Set up targets environment

Here we run necessary code for `targets` setup.

```{r setup, include = FALSE}
here::set_here()
knitr::opts_chunk$set(collapse = TRUE, comment = "#>")

# load libraries for targets notebook
library(targets)
library(dplyr, quietly = TRUE)

# clean knitting history
tar_unscript()
```

# Dependencies

Here, we load packages and custom functions required in the pipeline.

```{r, engine="targets", example-globals, tar_globals = TRUE}
options(tidyverse.quiet = TRUE)

# load libraries for make
tar_option_set(packages = c("dplyr",
                            "tidyr",
                            "purrr",
                            "readr",
                            "quanteda",
                            "igraph",
                            "DiagrammeR",
                            "tibble",
                            "stringr",
                            "topicmodels",
                            "ggplot2",
                            "scales",
                            "ldatuning",
                            "quanteda",
                            "data.table",
                            "tidytext",
                            "tm",
                            "RSQLite",
                            "DBI",
                            "MatchIt",
                            "qs",
                            "tidyverse",
                            "psych",
                            "arrow"
                            ))

# read custom functions
lapply(list.files(here::here("R"), full.names = TRUE), source)
```

# Data import

```{r, engine="targets", data_import}
list(
    
     tar_target(ids_path, here::here("data", "raw", "supervisors.csv"), format = "file"),
     tar_target(ids, read.csv2(ids_path)),
     tar_target(gender_path, here::here("data", "raw", "names4api_tagged.tsv"), format = "file"),
     tar_target(gender, read.delim(gender_path)),
     # tar_target(gender, read.delim(here::here("data", "raw", "names4api_tagged.tsv")),
     #          format = "qs"),
     tar_target(db_path,
           here::here("data", "raw", "czech_sci_db.sqlite")),
     tar_target(authors_arrow_path, here::here("data", "raw", "authors_by_pubs.arrow")),
     tar_target(authors_arrow, arrow::read_feather(authors_arrow_path)),
     tar_target(text_arrow_path, here::here("data", "raw", "riv_text.arrow")),
     tar_target(text_arrow, arrow::read_feather(text_arrow_path)),
     tar_target(ids_complete, create_ids_complete(ids, db_path)),
     tar_target(ids_complete_vector, make_ids_complete_vector(ids_complete))
   

)
```

# Matching and data preparation 

```{r, engine="targets", matching_preparation}
list(
    
      tar_target(matching, match(db_path, ids, gender, authors_arrow)),
      tar_target(sup_path, here::here("data", "raw", "supervisors_control_final.csv"), format = "file"),
      tar_target(sup_control, read.csv2(sup_path)),
              
     # tar_target(sup_control, read.csv2(here::here("data", "raw", "supervisors_control.csv")),
     #          format = "qs"),
      tar_target(final_data, refine_data(matching, db_path, ids, sup_control, authors_arrow)),
               
     #at this point, I will need to manually search for the supervisors of the control group researchers and upload their vedidks into new ids file
     tar_target(ids_full_vector,
               make_ids_full_vector(matching)),
     tar_target(all_pubs,
           get_all_pubs(db_path, final_data, authors_arrow, text_arrow)),
    tar_target(all_authors,
           read_all_authors(db_path, ids_complete_vector, ids_complete, final_data, ids_full_vector, authors_arrow)),
     tar_target(random_pubs,
           get_random_pubs(db_path, authors_arrow, text_arrow))
)
```

# Topic model

```{r, engine="targets", topic_model}
list(
    
   tar_target(topic_model_input,
              make_topic_model_input(random_pubs)),
   tar_target(topic_number,
              find_topic_number(topic_model_input),
                format = "qs"),
   tar_target(topic_model_original,
               make_topic_model(topic_model_input, topic_number),
                format = "qs"),
   tar_target(topic_model_input_addition,
              make_topic_model_input_addition(all_pubs)),
   tar_target(topic_model,
               make_topic_model_addition(topic_model_input_addition, topic_model_original),
                format = "qs")

    
)
```

# Coauthorship network

```{r, engine="targets", network}

list(

   
    tar_target(coauthorship,
               make_network(all_authors)),

     tar_target(coauthorship_graph,
               make_graph(coauthorship))

)

```

# Researcher independence indicator (RII) part 1 - eigenvector centrality

```{r, engine="targets", RII1}

list(
    
     tar_target(eigen_centrality,
               comp_eigen_centr(coauthorship_graph))
    
)

```

# Researcher independence indicator (RII) part 2 - clustering coefficient

```{r, engine="targets", RII2}

list(
    
    tar_target(cluster,
                comp_clustering(eigen_centrality))
    
    
)

```

# Researcher independence indicator (RII) part 3 - independent publications

```{r, engine="targets", RII3}

list(
    
   tar_target(independent_pubs,
                comp_ind_pubs(cluster))
)

```

# Researcher independence indicator (RII) part 4 - independent topics

```{r, engine="targets", RII4}

list(
    
    tar_target(independent_topics,
                comp_ind_topics(independent_pubs, topic_model, db_path, authors_arrow))
)

```

# Researcher independence indicator (RII) part 4 - independent topics: alternative way via cosine similarity

```{r, engine="targets", RII4_2}

list(
    
    # tar_target(ind_topics_cs,
    #            calc_cos_sim(topic_model, two_authors), 
    #            format = "qs")
    # 
)

```

# Final indicator

```{r, engine="targets", final}

list(
    
    #  # tar_target(testing,
    #  #           just_test(db_path),
    #  #           format = "qs")
    
    tar_target(full_indicator,
               calc_full_indicator(independent_topics, final_data))
    

)


```
# Article

```{targets article}
list(
    
    # tar_target(results,
    #            analyse(full_indicator),
    #            format = "qs") ,
    # tar_target(sup_testing,
    #            sup_test(matching, db_path, ids, sup_control, ids_complete),
    #            format = "qs") ,
    # 
    # tarchetypes::tar_render(article, here::here("Rmd", "article.Rmd"))
)


```

etc... rinse and repeat
